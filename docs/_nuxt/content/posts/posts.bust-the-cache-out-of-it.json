{
  "title": "Bust the cache out of it",
  "stage": "published",
  "tags": "nodejs, grunt, usemin, cache busting",
  "icon": "cloud",
  "comments": true,
  "published": true,
  "meta": {
    "index": 3,
    "fileName": "2014-05-01-bust-the-cache-out-of-it.md",
    "section": "/",
    "dirName": "/posts"
  },
  "date": "2014-05-01",
  "path": "/posts/posts/bust-the-cache-out-of-it",
  "permalink": "/posts/bust-the-cache-out-of-it",
  "anchors": [],
  "body": "<p>This will be a short one, the topic of cache busting isn’t new, it’s covered by a wide range of articles. What I’ll cover here is the basics and how I tackled a particular scenario.</p>\n<hr>\n<h3>Why cache busting?</h3>\n<p>It’s a strategy made popular due to how the majority of the www internet works, a story told with two major actors:</p>\n<ul>\n<li>Caching Proxies, many of which exist between your browser and the websites you visit.</li>\n<li>Your Browser: nuff said.</li>\n</ul>\n<p>Many of them are configured in different ways, but mostly they exist to alleviate the amount of data being moved around at the extremities.</p>\n<p>The affects on websites isn’t apparent until you try to update some external asset files (images, javascript, stylehseets, fonts, etc). When people visit your site in the initial version their browser and all the caching proxies saved copies of the assets. When you updated those assets, your browser and the caching proxies only determine if they need to get a new copy based on a few bits of meta data (most of which the average webserver doesn’t deliver). The end result is that your website starts having problems due to incorrect stylesheets, scripts and fonts.</p>\n<h3>An initial strategy</h3>\n<p>One of the first solutions to show up in response to this was to simply put a GET parameter after any asset you linked to :</p>\n<pre class=\"language-html\"><code class=\"language-html\">logo.png?cachebust={% now %}\n</code></pre>\n<p>Here in this example, I’m using preprocessed html templating language <code>jinja</code>. Simply inserting the current timestamp as a query param helps to fool some caching proxies and browsers to fetch the file again. They do this because they think the resource is dynamic.</p>\n<p>The problem with this is that some proxies and browsers ignore this and serve the same file again.</p>\n<h3>A strategy, robust</h3>\n<p>People with more perseverance sought a more robust strategy, one that would guarantee the correct file is delivered.</p>\n<p>It starts with the idea that your assets only change if you push new assets into the deployment workflow, so if they’re not changing between deployments and the proxy servers are ignoring GET parameters, then why don’t we change the file name each deployment only if the file changes?</p>\n<p>This is the goal of <code>grunt-usemin</code> and <code>grunt-rev</code>, two tools used with the Grunt task runner.</p>\n<h4>Peculiar problem of relative paths</h4>\n<p>The situation is that some of my pages in this website have images generated from something that looks at a directory and says “alrght, lets make a collection of images”, other pages I point at the image myself in the markdown. Sometimes it’s relative pathing, sometimes absolute.</p>\n<p>By default <code>grunt-usemin</code> only operates on absolute paths, assuming you’ll be keeping all your assets in a common location.</p>\n<p>To get all your files revved I ended up with the following :</p>\n<pre class=\"language-coffeescript\"><code class=\"language-coffeescript\">\n    <span class=\"token property\">useminPrepare</span><span class=\"token punctuation\">:</span>\n      <span class=\"token property\">dist</span><span class=\"token punctuation\">:</span>\n        <span class=\"token property\">src</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'&lt;%= paths.dist %>/**/*.html'</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token property\">rev</span><span class=\"token punctuation\">:</span>\n      <span class=\"token property\">dist</span><span class=\"token punctuation\">:</span>\n        <span class=\"token property\">files</span><span class=\"token punctuation\">:</span>\n          <span class=\"token property\">src</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'&lt;%= paths.dist %>/assets/js/{,*/}*.js'</span>\n            <span class=\"token string\">'&lt;%= paths.dist %>/assets/css/{,*/}*.css'</span>\n            <span class=\"token string\">'&lt;%= paths.dist %>/assets/font/{,*/}*.{ttf,eot,otf,woff,svg}'</span>\n            <span class=\"token string\">'&lt;%= paths.dist %>/{,**/}**.{png,jpg,jpeg,gif,webp,svg}'</span>\n          <span class=\"token punctuation\">]</span>\n\n    <span class=\"token property\">usemin</span><span class=\"token punctuation\">:</span>\n      <span class=\"token property\">options</span><span class=\"token punctuation\">:</span>\n        <span class=\"token property\">assetsDirs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">'&lt;%= paths.dist %>/**/*'</span>\n          <span class=\"token string\">'&lt;%= paths.dist %>/'</span>\n        <span class=\"token punctuation\">]</span>\n        <span class=\"token property\">patterns</span><span class=\"token punctuation\">:</span>\n          <span class=\"token property\">html</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">[</span><span class=\"token regex\">/(js\\/[\\w\\d-]*\\.js)/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Replacing javascript link\"</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">[</span><span class=\"token regex\">/(css\\/[\\w\\d-]*\\.css)/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Replacing stylesheet link\"</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">[</span><span class=\"token regex\">/(img\\/[\\w\\d-]*\\.(png|jpeg|jpg|gif))/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Replacing image link\"</span><span class=\"token punctuation\">]</span>\n          <span class=\"token punctuation\">]</span>\n\n      <span class=\"token property\">html</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'&lt;%= paths.dist %>/**/*.html'</span><span class=\"token punctuation\">]</span>\n      <span class=\"token property\">css</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'&lt;%= paths.dist %>/assets/css/**/*.css'</span><span class=\"token punctuation\">]</span>\n\n</code></pre>\n<p>I believe the important parts are :</p>\n<ul>\n<li>\n<p><em>useminPrepare.dist.src</em>\n: Nothing occurs without this… pretty standard stuff, it just points useminPrepare at the collection of files to operate on.</p>\n</li>\n<li>\n<p><em>rev.dist.files.src -&gt; last item</em>\n: Need to be able to act on any image, regardless of where it is.</p>\n</li>\n<li>\n<p><em>usemin.options.patterns.html</em>\n: This overrides the default matching and applies simple pattern matching of my own that allows for matching relative paths, as long as they start with <code>img/</code>.</p>\n</li>\n</ul>\n<h3>Conclusion</h3>\n<p><em>Is it perfect?</em>\n: problaby not.</p>\n<p><em>Does it work?</em>\n: yes.</p>\n<p><em>What do I think can be improved?</em>\n:remove the need to be in an <code>img</code> folder.</p>\n<p>Without cache busting, your life as a web developer is considerably more stressful. Phone calls, tickets, whispers you shouldn’t have to deal with, they all start hanging on your shoulders.</p>\n"
}